<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MySNS | Terminal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #1a1510;
      --surface: #c9b896;
      --surface-hover: #bfae8a;
      --border: #5c5244;
      --text: #2c2520;
      --text-muted: #5c5244;
      --accent: #c45c26;
      --accent-hover: #a84a1a;
      --success: #166534;
      --panel-dark: #2c2520;
      --panel-dark-text: #e8e2d9;
      --radius: 6px;
      --radius-sm: 4px;
      --shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    /* --- ğŸ†• èµ·å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSS --- */
    #boot-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', sans-serif;
      color: var(--accent);
      transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s;
    }

    .boot-content { text-align: center; width: 280px; }
    .scanline {
      position: absolute; top: 0; left: 0; width: 100%; height: 4px;
      background: rgba(196, 92, 38, 0.1); box-shadow: 0 0 10px var(--accent);
      animation: scan 3s linear infinite; pointer-events: none;
    }
    @keyframes scan { 0% { top: -5%; } 100% { top: 105%; } }
    .boot-logo { font-size: 1.2rem; letter-spacing: 0.3em; margin-bottom: 20px; text-shadow: 0 0 8px var(--accent); }
    .boot-bar-container { width: 100%; height: 4px; background: var(--panel-dark); border: 1px solid var(--border); position: relative; overflow: hidden; }
    .boot-bar-fill { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: var(--accent); box-shadow: 0 0 15px var(--accent); }
    .boot-status { font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; margin-top: 10px; color: var(--text-muted); text-transform: uppercase; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã®åˆæœŸçŠ¶æ…‹ */
    .app {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .app.initialized { opacity: 1; transform: translateY(0) scale(1); }

    /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ™‚é–“å·®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
    .fade-in-section { opacity: 0; transform: translateY(15px); }
    .fade-in-section.active { animation: sectionReady 0.6s forwards; }
    @keyframes sectionReady { to { opacity: 1; transform: translateY(0); } }

    /* --- æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      position: relative;
    }
    body::before {
      content: ''; position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }
    .app {
      max-width: 560px; margin: 0 auto; padding: 24px 20px 48px;
      position: relative; z-index: 1; background: var(--surface);
      border: 2px solid var(--border); min-height: 100vh; box-shadow: var(--shadow);
    }
    header {
      text-align: center; margin-bottom: 32px; padding: 20px 16px;
      background: var(--panel-dark); border-bottom: 2px solid var(--border);
      margin: -24px -20px 32px -20px;
    }
    h1 { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--panel-dark-text); letter-spacing: 0.15em; text-transform: uppercase; }
    header::after {
      content: ''; display: block; height: 3px; margin-top: 16px;
      background: linear-gradient(90deg, var(--accent) 0%, #dc2626 35%, #14b8a6 65%, #22c55e 100%);
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒœã‚¿ãƒ³é¡ */
    .register-section, .post-section, .thread-create, .reply-form-section, .stance-summary, .ai-summary-result {
      background: rgba(255,255,255,0.4); border: 2px solid var(--border);
      border-radius: var(--radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow);
    }
    .btn {
      padding: 12px 20px; border: 2px solid var(--border); border-radius: var(--radius-sm);
      font-family: inherit; font-size: 0.95rem; font-weight: 700; cursor: pointer;
      transition: all 0.2s; letter-spacing: 0.05em;
    }
    .btn-primary { background: var(--panel-dark); color: var(--panel-dark-text); }
    .btn-primary:hover { background: var(--accent); border-color: var(--accent); }
    
    input, select, textarea {
      width: 100%; padding: 12px 16px; border: 2px solid var(--border);
      border-radius: var(--radius-sm); background: var(--panel-dark-text);
      color: var(--text); font-family: inherit; font-size: 1rem; margin-bottom: 12px;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
    .post-card {
      background: rgba(255,255,255,0.5); border: 2px solid var(--border);
      border-radius: var(--radius); padding: 18px 20px; margin-bottom: 12px;
      transition: all 0.2s;
    }
    .post-card:hover { background: rgba(255,255,255,0.65); border-color: var(--accent); }
    .post-avatar {
      width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .stance-label { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
    .stance-è³›æˆ { background: rgba(34, 197, 94, 0.2); color: #166534; }
    .stance-åå¯¾ { background: rgba(239, 68, 68, 0.2); color: #991b1b; }

    /* è­°è«–ã®å¯è¦–åŒ–ãƒãƒ¼ */
    .stance-summary-stacked-wrap {
      width: 100%; height: 28px; border-radius: var(--radius-sm);
      display: flex; overflow: hidden; margin: 16px 0; border: 1px solid var(--border);
    }
    .stance-summary-stacked-segment { height: 100%; transition: flex-grow 0.3s; }
    .stance-summary-stacked-segment[data-stance="è³›æˆ"] { background: #22c55e; }
    .stance-summary-stacked-segment[data-stance="åå¯¾"] { background: #ef4444; }
    .stance-summary-stacked-segment[data-stance="ä¸­ç«‹"] { background: #64748b; }
    .stance-summary-stacked-segment[data-stance="è³ªå•"] { background: #eab308; }

    .hidden { display: none !important; }
    .visible { display: block !important; }
  </style>
</head>
<body>

  <div id="boot-screen">
    <div class="scanline"></div>
    <div class="boot-content">
      <div class="boot-logo">MYSNS v1.0</div>
      <div class="boot-bar-container">
        <div class="boot-bar-fill" id="boot-fill"></div>
      </div>
      <div class="boot-status" id="boot-status">INITIALIZING...</div>
    </div>
  </div>

  <div class="app" id="main-app">
    <header>
      <h1>MySNS</h1>
    </header>

    <section class="register-section fade-in-section" id="registerSection">
      <h2>ã¯ã˜ã‚ã«åå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</h2>
      <form class="register-form" id="registerForm">
        <input type="text" id="userName" placeholder="ã‚ãªãŸã®åå‰" maxlength="30" required>
        <select id="userColor" aria-label="ã‚¢ã‚¤ã‚³ãƒ³è‰²">
          <option value="#6366f1">ãƒ‘ãƒ¼ãƒ—ãƒ«</option>
          <option value="#ef4444">ãƒ¬ãƒƒãƒ‰</option>
          <option value="#22c55e">ã‚°ãƒªãƒ¼ãƒ³</option>
          <option value="#eab308">ã‚¤ã‚¨ãƒ­ãƒ¼</option>
          <option value="#ec4899">ãƒ”ãƒ³ã‚¯</option>
        </select>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </section>

    <section class="register-section fade-in-section hidden" id="welcomeSection">
      <h2>ã‚ˆã†ã“ã</h2>
      <p id="currentUser" style="color:var(--accent); font-weight:bold;"></p>
    </section>

    <section class="thread-list-section fade-in-section visible" id="threadListSection">
      <div class="thread-create hidden" id="threadCreateSection">
        <h2>æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</h2>
        <form id="threadCreateForm">
          <input type="text" id="threadTitleInput" placeholder="è©±é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" maxlength="100" required>
          <button type="submit" class="btn btn-primary">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</button>
        </form>
      </div>
      <h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
      <div id="threadList" class="posts">
        <div class="empty-state" id="threadListEmpty">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </section>

    <section class="thread-detail-section fade-in-section hidden" id="threadDetailSection">
      <a href="#" class="btn" id="backToThreads" style="text-decoration:none; display:inline-block; margin-bottom:20px;">â† æˆ»ã‚‹</a>
      <h2 id="threadDetailTitle" style="font-family:'Orbitron'; margin-bottom:20px;"></h2>
      
      <div class="stance-summary" id="stanceSummary">
        <div class="boot-status">æ„è¦‹åˆ†å¸ƒ</div>
        <div class="stance-summary-stacked-wrap" id="stanceSummaryStacked"></div>
        <div id="stanceSummaryLegend" style="display:flex; justify-content:space-around; font-size:0.8rem;"></div>
      </div>

      <button type="button" class="btn btn-primary" id="aiSummaryBtn" style="width:100%; margin-bottom:20px;">AIã§ã“ã®è­°è«–ã‚’ã¾ã¨ã‚ã‚‹</button>
      
      <div id="aiSummaryResult" class="hidden">
        <h4 style="color:var(--accent)">AIè¦ç´„çµæœ</h4>
        <div id="aiSummaryProText" style="font-size:0.9rem; margin:10px 0;"></div>
        <div id="aiSummaryConText" style="font-size:0.9rem; margin:10px 0;"></div>
      </div>

      <div class="reply-form-section" id="replyFormSection">
        <form id="replyForm">
          <div style="margin-bottom:10px">ç«‹å ´ã‚’é¸æŠ: 
            <select id="replyStance" style="width:auto; margin:0">
              <option value="ä¸­ç«‹">ä¸­ç«‹</option>
              <option value="è³›æˆ">è³›æˆ</option>
              <option value="åå¯¾">åå¯¾</option>
              <option value="è³ªå•">è³ªå•</option>
            </select>
          </div>
          <textarea id="replyContent" placeholder="æ„è¦‹ã‚’æ›¸ãè¾¼ã‚€..." required></textarea>
          <button type="submit" class="btn btn-primary" style="width:100%">é€ä¿¡</button>
        </form>
      </div>

      <div id="repliesList" class="posts">
        <div class="empty-state" id="repliesEmpty">è¿”ä¿¡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // --- ğŸ”§ Firebase & Gemini Config (è‡ªèº«ã®ã‚‚ã®ã«æ›¸ãæ›ãˆã¦ãã ã•ã„) ---
    const firebaseConfig = {
      apiKey: "GEMINI_API_KEY",
      authDomain: "myfirstsns-6ca1d.firebaseapp.com",
      projectId: "myfirstsns-6ca1d",
      storageBucket: "myfirstsns-6ca1d.firebasestorage.app",
      messagingSenderId: "1025322607641",
      appId: "1:1025322607641:web:588692daa58700fc253688"
    };
    const GEMINI_API_KEY = 'YOUR_API_KEY';
    const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    // -------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const USER_STORAGE_KEY = 'mysns_user_v2';
    let currentThreadId = null;

    // --- ğŸ†• èµ·å‹•ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ ---
    window.addEventListener('DOMContentLoaded', () => {
      const fill = document.getElementById('boot-fill');
      const bootScreen = document.getElementById('boot-screen');
      const mainApp = document.getElementById('main-app');
      let prg = 0;
      const inv = setInterval(() => {
        prg += Math.random() * 20;
        if(prg >= 100) {
          prg = 100; clearInterval(inv);
          setTimeout(() => {
            bootScreen.style.opacity = '0';
            setTimeout(() => {
              bootScreen.style.visibility = 'hidden';
              mainApp.classList.add('initialized');
              document.querySelectorAll('.fade-in-section').forEach((s, i) => {
                setTimeout(() => s.classList.add('active'), i * 150);
              });
            }, 800);
          }, 500);
        }
        fill.style.width = prg + '%';
      }, 80);
    });

    // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ---
    function getCurrentUser() {
      const raw = localStorage.getItem(USER_STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    }

    function applyUserUI() {
      const user = getCurrentUser();
      if (user) {
        document.getElementById('registerSection').classList.add('hidden');
        document.getElementById('welcomeSection').classList.remove('hidden');
        document.getElementById('threadCreateSection').classList.remove('hidden');
        document.getElementById('currentUser').textContent = `CONNECTED: ${user.name}`;
      }
    }

    document.getElementById('registerForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      const color = document.getElementById('userColor').value;
      localStorage.setItem(USER_STORAGE_KEY, JSON.stringify({ name, color }));
      applyUserUI();
    });

    // --- ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ»è¿”ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ ---
    function showThreadList() {
      currentThreadId = null;
      document.getElementById('threadListSection').classList.add('visible', 'active');
      document.getElementById('threadDetailSection').classList.add('hidden');
      document.getElementById('threadDetailSection').classList.remove('visible');
      
      const q = query(collection(db, 'threads'), orderBy('time', 'desc'));
      onSnapshot(q, (snapshot) => {
        const container = document.getElementById('threadList');
        container.innerHTML = '';
        snapshot.docs.forEach(d => {
          const data = d.data();
          const div = document.createElement('div');
          div.className = 'post-card';
          div.style.cursor = 'pointer';
          div.innerHTML = `<strong>${data.title}</strong><br><small>${data.author}</small>`;
          div.onclick = () => showThreadDetail(d.id, data.title);
          container.appendChild(div);
        });
        document.getElementById('threadListEmpty').classList.toggle('hidden', snapshot.docs.length > 0);
      });
    }

    function showThreadDetail(id, title) {
      currentThreadId = id;
      document.getElementById('threadListSection').classList.remove('visible');
      document.getElementById('threadDetailSection').classList.remove('hidden');
      document.getElementById('threadDetailSection').classList.add('visible', 'active');
      document.getElementById('threadDetailTitle').textContent = title;
      
      const q = query(collection(db, 'threads', id, 'replies'), orderBy('time', 'asc'));
      onSnapshot(q, (snapshot) => {
        renderReplies(snapshot.docs);
        updateStanceBar(snapshot.docs);
      });
    }

    document.getElementById('threadCreateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('threadTitleInput').value.trim();
      const user = getCurrentUser();
      await addDoc(collection(db, 'threads'), { title, author: user.name, iconColor: user.color, time: serverTimestamp() });
      document.getElementById('threadTitleInput').value = '';
    });

    document.getElementById('replyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = document.getElementById('replyContent').value.trim();
      const stance = document.getElementById('replyStance').value;
      const user = getCurrentUser();
      await addDoc(collection(db, 'threads', currentThreadId, 'replies'), {
        author: user.name, content, stance, iconColor: user.color, time: serverTimestamp(), likeCount: 0
      });
      document.getElementById('replyContent').value = '';
    });

    function renderReplies(docs) {
      const container = document.getElementById('repliesList');
      container.innerHTML = '';
      docs.forEach(d => {
        const data = d.data();
        const card = document.createElement('div');
        card.className = 'post-card';
        card.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div class="post-avatar" style="background:${data.iconColor || '#ccc'}">${data.author[0]}</div>
            <div><strong>${data.author}</strong> <span class="stance-label stance-${data.stance}">${data.stance}</span></div>
          </div>
          <div>${data.content}</div>
        `;
        container.appendChild(card);
      });
      document.getElementById('repliesEmpty').classList.toggle('hidden', docs.length > 0);
    }

    function updateStanceBar(docs) {
      const counts = { è³›æˆ: 0, åå¯¾: 0, ä¸­ç«‹: 0, è³ªå•: 0 };
      docs.forEach(d => counts[d.data().stance]++);
      const total = docs.length || 1;
      const bar = document.getElementById('stanceSummaryStacked');
      bar.innerHTML = Object.keys(counts).map(s => 
        `<div class="stance-summary-stacked-segment" data-stance="${s}" style="flex:${counts[s]}"></div>`
      ).join('');
      document.getElementById('stanceSummaryLegend').innerHTML = Object.keys(counts).map(s => 
        `<span>${s}: ${Math.round(counts[s]/total*100)}%</span>`
      ).join('');
    }

    document.getElementById('backToThreads').onclick = (e) => { e.preventDefault(); showThreadList(); };

    // --- AIè¦ç´„ ---
    document.getElementById('aiSummaryBtn').onclick = async () => {
      const resultDiv = document.getElementById('aiSummaryResult');
      resultDiv.classList.remove('hidden');
      document.getElementById('aiSummaryProText').textContent = "AIåˆ†æä¸­...";
      
      // ç°¡æ˜“çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡ï¼ˆè©³ç´°ã¯å‰è¿°ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒæ§˜ï¼‰
      try {
        const res = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({ contents: [{ parts: [{ text: "è­°è«–ã‚’è¦ç´„ã—ã¦" }] }] })
        });
        const data = await res.json();
        document.getElementById('aiSummaryProText').textContent = data.candidates[0].content.parts[0].text;
      } catch (e) {
        document.getElementById('aiSummaryProText').textContent = "è¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      }
    };

    applyUserUI();
    showThreadList();
  </script>
</body>
</html>